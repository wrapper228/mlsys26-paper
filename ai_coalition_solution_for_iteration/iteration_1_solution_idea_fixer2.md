## Цель фикса (без ослабления основного утверждения)

Критика ICML/attacker’ов бьёт не по claim “\(\mathbb{E}\|q_i^{(T)}\|\) nondecreasing in \(p_i\)”, а по **текущему способу доказательства**, который пытается получить этот claim через *almost sure pathwise dominance* при \(c'\neq c''\) (и это действительно ломается контрпримером).

Самое сильное направление фикса — **переписать доказательство Section 3 / Appendix “Popularity Dependence via Coupling” так, чтобы оно не требовало шага вида**
\(\;s' \le s'' \Rightarrow s' + c'/s' \le s'' + c''/s''\;\) **при \(c'\neq c''\)**.
Именно этот шаг сейчас и ломается.

Ниже — конкретная конструкция.

---

## A. Обязательные правки (строго корректные, независимы от выбора основного фикса)

### FIX A1: исправить “Eq. (10) \(\Delta q_i=-\eta c_i g_i\)” на корректную форму при дублях

Это нужно сделать независимо, иначе рецензент легко зацепится за “перепутали индекс item и индекс примера”.

Для embedding layer:

\[
\Delta q_v \;=\; -\eta \sum_{b:\,x_b=v} g_b.
\]

Если хотите сохранить множитель “count”, вводите
\[
\bar g_v := \frac{1}{n_v}\sum_{b:\,x_b=v} g_b,\quad n_v:=|\{b:x_b=v\}|,
\]
тогда \(\Delta q_v=-\eta\,n_v\,\bar g_v\).

И отдельно строкой: “так как каждый \(g_b\perp q_v\), то сумма/среднее тоже \(\perp q_v\)”.

### FIX A2: разнести индексы и нотацию, чтобы убрать формальную неоднозначность

Минимальный жёсткий стандарт:

- \(b\in\{1,\dots,B\}\): слот батча, \(g_b,J_b,x_b\);
- \(v\in\{1,\dots,N\}\): item-id, \(q_v,\Delta q_v,s_v\).

Это надо протянуть через Section 2.4 и Appendix D.

### FIX A3: переименовать перегруженный символ \(c\)

Три разных “\(c\)” реально провоцируют misread.

Предлагаю:

- \(n_v\) — count в батче (бывш. \(c_i\) в Section 2.4),
- \(\rho_i(q)\) — cosine similarity (бывш. \(c_i(q)\) в Appendix C),
- \(\kappa\) или \(\kappa_t\) — gradient-magnitude factor \(\eta^2\|Pu\|^2\) (бывш. \(c\) в Appendix D/G).

### FIX A4: “скрытые условия” сделать явными (без изменения существа результатов)

Это почти бесплатные правки, которые снимают weak-reject-вайб:

- **\(s_0>0\)**: корректность формул вида \(\Delta(s)=\kappa/s\) требует \(s>0\); написать, что стандартная random init даёт \(\|q^{(0)}\|>0\) a.s., а padding/нулевые токены исключены из loss.
- **i.i.d. режим выборки**: если proof использует i.i.d. слоты, это надо явно поднять в “Scope” теоремы/аппендикса.
- **\(d\ge 2\)**: сноска про вырожденность \(d=1\).
- **Cauchy–Schwarz**: одна строка про неотрицательность подкоренного.
- **минимальная регулярность \(F\)**: если в тексте заявлено “любой cosine-based loss”, то хотя бы differentiability (чтобы \(\partial F/\partial \rho_i\) имело смысл) надо прописать как техническую предпосылку, а не оставлять неявной.

---

## B. Критический фикс доказательства монотонности по \(p_i\) (что именно надо сделать)

Ниже — 3 пути. Важно: **ни один из них нельзя честно считать “готовым”, пока не написана соответствующая лемма/переопределение вероятностного объекта**. Я формулирую их так, чтобы каждое утверждение было 100% корректно.

### FIX B1: occurrence-time подход (работает, если условное распределение “контекста” не меняется при варьировании \(p_i\))

Идея: уйти от “order preservation между двумя разными \(\Phi',\Phi''\)” и доказывать монотонность через случайное число обновлений айтема \(K_T\) и процесс по появлениям.

Ключевой технический пункт: нужно зафиксировать вероятностный объект так, чтобы при изменении \(p_v\) менялась **только частота появления** айтема \(v\), но **не менялось** условное распределение той случайности, которая определяет \(\kappa\), при условии \(X=v\).

Это можно оформить так:

- данные/слоты генерируются i.i.d. из распределения по \((\xi,X)\),
- семейство распределений параметризовано \(p=\mathbb{P}\{X=v\}\) и residual \(r\) для \(X\neq v\),
- и дополнительно явно фиксируется, что \(\mathbb{P}(\xi\mid X=v)\) не зависит от \(p\).

Тогда:

- определяем \(s_k\) — квадрат нормы после \(k\)-го появления айтема \(v\),
- имеем одношаговый рост \(s_{k+1}=s_k+\kappa_k/s_k\) с \(\kappa_k\ge0\),
- \(K_T\) stochastically increasing по \(p\),
- и из неубывания \(\mathbb{E}[s_k]\) по \(k\) следует неубывание \(\mathbb{E}[s_{K_T}]\) по \(p\).

**Критический риск/что надо явно закрыть:** для *in-batch negatives* в InfoNCE \(\xi\) включает состав батча, и тогда \(\mathbb{P}(\xi\mid X=v)\) вообще говоря зависит от \(p\). Значит FIX B1 не “автоматически применим” к in-batch InfoNCE: либо надо доказать, что зависимость не мешает монотонности, либо перейти к формализации негативов, где \(\xi\) действительно фиксируется при варьировании \(p\).

### FIX B2: формализовать негативы так, чтобы B1 стал применим (независимые/внешние негативы)

Если в теоретической постановке вы определяете contrastive objective, где негативы \(K_1,\dots,K_m\) для каждого positive генерируются i.i.d. из фиксированного residual \(r\) (или фиксированной смеси), то условное распределение \(\xi\mid X=v\) действительно не зависит от \(p\), и occurrence-time proof из B1 становится строго применим.

**Важно:** это корректно как математическая модель, но нужно аккуратно синхронизировать её с текстом статьи (особенно если вы одновременно заявляете результаты именно про “in-batch negatives”). Здесь нельзя оставлять двусмысленность: либо теорема про такой negative-sampling, либо нужен отдельный мост к in-batch.

### FIX B3: оставить in-batch InfoNCE и доказать новую лемму, убивающую контрпример ревьюера

Это путь “без смены постановки”, но он самый трудоёмкий: нужно доказать **конкретное утверждение про InfoNCE**, которое заменит сломанный шаг “\(\Phi\) монотонна”.

Два возможных поднаправления:

- **B3.1 (контроль различий \(c'\) и \(c''\))**: доказать достаточно сильную оценку вида
  \(|c''-c'|\le \Psi(s'',s')\) (или W.H.P.), которая гарантирует сохранение порядка в индукции.

- **B3.2 (монотонность \(\kappa\) по кратности \(n_v\))**: идея из прежнего “FIX 1C” — показать, что добавление копий айтема \(v\) в батч не может сделать \(\kappa=\eta^2\|Pu\|^2\) меньше.
  Это выглядит правдоподобно из-за softmax-структуры, но **это нужно реально доказать или опровергнуть контрпримером**; в текущем виде это нельзя подавать как готовый фикс.

---

## Итог: что в этом файле “актуально” в строгом смысле

- Блок **A (A1–A4)**: это реальные, корректные правки текста/нотации/выводов, которые стоит принять независимо от того, как именно вы чините центральную теорему.
- Блок **B (B1–B3)**: это корректно сформулированные направления *как именно* чинить доказательство монотонности по \(p_i\). Они актуальны, но не “автоматически истинны”: в каждом из них есть конкретное место, где нужна новая лемма или аккуратная формализация вероятностной модели.

